---
- name: Check if Broker CRD is installed
  command: kubectl get crd activemqartemises.broker.amq.io
  register: broker_crd_check
  ignore_errors: yes

- block:
    - name: End playbook if Broker CRD is already installed
      meta: end_play
      when: broker_crd_check.rc == 0

    - name: Create installation directory
      file:
        path: "~/broker/operator"
        state: directory

    - name: Clean up previous installation
      file:
        path: "~/broker/operator/activemq-artemis-operator-1.0.16"
        state: absent

    - name: Clean up previous installation
      file:
        path: "~/broker/operator/activemq-artemis-operator-1.0.16.zip"
        state: absent

    - name: Download the Operator
      get_url:
        url: "https://github.com/artemiscloud/activemq-artemis-operator/archive/v1.0.16.zip"
        dest: "~/broker/operator/activemq-artemis-operator-1.0.16.zip"

    - name: Unzip the Operator
      unarchive:
        src: "~/broker/operator/activemq-artemis-operator-1.0.16.zip"
        dest: "~/broker/operator"

    - name: Set Kubernetes Context for Cluster-Wide Access
      shell: |
        kubectl config set-context $(kubectl config current-context) --namespace=default

    - name: Create Service Account
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/service_account.yaml
      ignore_errors: yes

    - name: Create Role
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/role.yaml
      ignore_errors: yes

    - name: Create Role Binding
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/role_binding.yaml
      ignore_errors: yes

    - name: Deploy Broker CRD
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/crds/broker_activemqartemis_crd.yaml

    - name: Deploy Address CRD
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/crds/broker_activemqartemisaddress_crd.yaml

    - name: Deploy Scaledown Controller CRD
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/crds/broker_activemqartemisscaledown_crd.yaml

    - name: Deploy Security crd
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/crds/broker_activemqartemissecurity_crd.yaml

    - name: Deploy the Operator
      shell: kubectl create -f ~/broker/operator/activemq-artemis-operator-1.0.16/deploy/operator.yaml

  when:
    - broker_crd_check.rc != 0
